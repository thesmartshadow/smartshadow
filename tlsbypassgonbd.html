<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تقرير ثغرة أمنية | تجاوز التحقق من شهادة TLS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }

        .animated-gradient-text {
            background: linear-gradient(90deg, #a78bfa, #f472b6, #60a5fa, #a78bfa);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient-animation 6s ease infinite;
        }

        .code-block {
            background-color: #1f2937;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 16px;
            position: relative;
            direction: ltr; /* Code is LTR */
            text-align: left;
        }
        .code-block pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
        }
        .copy-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background-color: #374151;
            color: #9ca3af;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }
        .copy-btn:hover {
            background-color: #4b5563;
            transform: scale(1.1);
        }
        .highlight-line {
            background-color: #4f46e530;
            display: block;
            margin: 0 -16px;
            padding: 0 16px;
            border-left: 3px solid #6366f1;
        }
        .section-card {
            background-color: #1f2937;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #374151;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            opacity: 0; /* Initially hidden for animation */
        }
        .section-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.2), 0 4px 6px -2px rgb(0 0 0 / 0.1);
        }
        .is-visible {
            animation: fadeInUp 0.8s ease forwards;
        }
        .tag {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 9999px;
            font-weight: 500;
            font-size: 12px;
            transition: transform 0.2s;
        }
        .tag:hover {
             transform: scale(1.05);
        }
        .severity-high {
            background-color: #991b1b;
            color: #fecaca;
        }
        .cwe-tag {
            background-color: #1d4ed8;
            color: #dbeafe;
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
        <!-- Header -->
        <header class="text-center mb-10 opacity-0 is-visible">
            <h1 class="text-3xl sm:text-4xl font-bold text-white mb-2 animated-gradient-text">تحليل أمني معمّق: تجاوز التحقق من شهادة TLS</h1>
            <p class="text-lg text-gray-400">مشروع: <span class="font-mono text-indigo-400">digitalocean/go-nbd</span></p>
            <p class="text-xl text-gray-300 mt-4">إعداد الباحث الأمني: <span class="font-bold text-white">Ali Firas</span></p>
        </header>

        <main>
            <!-- Summary Section -->
            <section id="summary" class="section-card">
                <h2 class="text-2xl font-bold text-indigo-400 mb-4 border-b-2 border-gray-700 pb-2">1. الملخص التنفيذي</h2>
                <p class="mb-4">
                    بعد إجراء مراجعة دقيقة للشفرة المصدرية (Source Code Review) لمشروع <span class="font-mono text-gray-300">go-nbd</span>، تم الكشف عن ثغرة أمنية حرجة تتمثل في تجاوز عملية التحقق من صحة شهادة TLS. تنشأ هذه المشكلة لأن آلية الاختبار تقوم بتعطيل التحقق من الشهادة بشكل كامل من خلال تعيين قيمة <span class="font-mono text-red-400">InsecureSkipVerify: true</span>. هذا الإعداد يسمح للعميل بقبول أي شهادة، بما في ذلك الشهادات الموقعة ذاتيًا أو غير الموثوقة، مما يفتح الباب أمام هجمات الوسيط (Man-in-the-Middle) لاعتراض وفك تشفير البيانات الحساسة.
                </p>
                <div class="flex flex-wrap gap-3">
                    <span class="tag severity-high">الخطورة: عالية</span>
                    <span class="tag cwe-tag">CWE-295: Improper Certificate Validation</span>
                    <span class="tag" style="background-color: #047857; color: #a7f3d0;">ناقل الهجوم: شبكي (MITM)</span>
                </div>
            </section>

            <!-- Vulnerable Code Section -->
            <section id="vulnerable-code" class="section-card">
                <h2 class="text-2xl font-bold text-indigo-400 mb-4 border-b-2 border-gray-700 pb-2">2. الشفرة المصدرية المصابة</h2>
                <p class="mb-4">
                    تم تحديد نقطة الضعف في ملف <span class="font-mono text-gray-300">nbdkit_test.go</span>. الشيفرة التالية، الموجودة في دالتي <span class="font-mono text-gray-300">provideSecureNBD</span> و <span class="font-mono text-gray-300">provideSecureNBDUnix</span>، هي السبب المباشر للثغرة:
                </p>
                <div class="code-block">
                    <button class="copy-btn" onclick="copyCode(this)">نسخ</button>
                    <pre><code class="language-go">
tlsConf = &tls.Config{
    RootCAs:          certPool,
    <span class="highlight-line">InsecureSkipVerify: true, //  Disables all certificate validation</span>
}
                    </code></pre>
                </div>
                 <p class="mt-4 text-sm text-gray-400">
                    <strong class="text-yellow-400">ملاحظة فنية:</strong> إن وجود السطر <code class="font-mono text-red-400">InsecureSkipVerify: true</code> يلغي فعليًا أي فائدة من توفير <code class="font-mono text-gray-300">RootCAs</code>، حيث يتم تجاهل عملية التحقق بالكامل.
                </p>
            </section>
            
            <!-- Technical Details Section -->
            <section id="technical-details" class="section-card">
                <h2 class="text-2xl font-bold text-indigo-400 mb-4 border-b-2 border-gray-700 pb-2">3. تحليل فني معمّق</h2>
                <p class="mb-4">
                    عند تفعيل الخاصية <code class="font-mono text-red-400">InsecureSkipVerify: true</code> في حزمة TLS الخاصة بلغة Go، يتم تخطي عمليتين حاسمتين للأمان:
                </p>
                <ul class="list-disc list-inside space-y-2 mb-4 pr-4">
                    <li><strong class="text-gray-300">التحقق من سلسلة الشهادات (Certificate chain validation):</strong> لا يتم التحقق مما إذا كانت الشهادة المقدمة من الخادم موقعة من قبل مرجع مصدق (CA) موثوق به.</li>
                    <li><strong class="text-gray-300">التحقق من اسم المضيف (Hostname verification):</strong> لا يتم التحقق مما إذا كان الاسم الشائع (Common Name) أو الاسم البديل للموضوع (Subject Alternative Name) في الشهادة يطابق اسم المضيف الذي يحاول العميل الاتصال به.</li>
                </ul>
                <p>
                   هذا يسمح للمهاجم بتنفيذ هجوم الوسيط (MITM) بسهولة عبر الخطوات التالية:
                </p>
                <ol class="list-decimal list-inside space-y-2 pr-4 mt-4">
                    <li>يقوم المهاجم باعتراض حركة مرور الشبكة (عبر DNS spoofing, ARP poisoning).</li>
                    <li>يقدم المهاجم شهادة مزيفة وموقعة ذاتيًا للعميل.</li>
                    <li>العميل، بسبب <code class="font-mono text-red-400">InsecureSkipVerify: true</code>، يقبل الشهادة المزيفة دون تردد.</li>
                    <li>يتم إنشاء جلسة TLS "آمنة" مع المهاجم، الذي يمكنه الآن قراءة وتعديل جميع البيانات المرسلة.</li>
                </ol>
            </section>

            <!-- Proof of Concept Section -->
            <section id="poc" class="section-card">
                <h2 class="text-2xl font-bold text-indigo-400 mb-4 border-b-2 border-gray-700 pb-2">4. توثيق قبول التقرير</h2>
                <p class="mb-4">
                    لإثبات التأثير العملي وأهمية هذه الثغرة، تم تقديم التقرير إلى الجهة المسؤولة وتم قبوله، مما يؤكد صحة النتائج وخطورتها.
                </p>
                <div class="my-6">
                    <img src="https://i.imgur.com/v0IP81w.jpeg" alt="Proof of Concept Output" class="rounded-lg shadow-lg w-full h-auto object-cover border-2 border-gray-600 transition-transform duration-300 hover:scale-105">
                    <p class="text-center text-sm mt-2 text-gray-500">صورة توضح قبول التقرير من قبل الشركة.</p>
                </div>
            </section>

            <!-- Impact Section -->
            <section id="impact" class="section-card">
                <h2 class="text-2xl font-bold text-indigo-400 mb-4 border-b-2 border-gray-700 pb-2">5. الأثر والمخاطر</h2>
                <ul class="list-disc list-inside space-y-3 pr-4">
                    <li>
                        <strong class="text-red-400">خرق السرية (Confidentiality Breach):</strong> يمكن للمهاجم اعتراض وقراءة أي بيانات حساسة يتم إرسالها، مثل محتويات القرص أو بيانات المصادقة.
                    </li>
                    <li>
                        <strong class="text-red-400">خرق السلامة (Integrity Breach):</strong> يمكن للمهاجم تعديل أو حقن بيانات NBD أثناء النقل دون أن يتم كشفه.
                    </li>
                    <li>
                        <strong class="text-yellow-400">سيناريو هجوم واقعي:</strong> يمكن لمهاجم على نفس الشبكة المحلية (LAN) انتحال شخصية خادم NBD الشرعي. سيقبل العميل الشهادة المزيفة للمهاجم، مما يمنح المهاجم وصولاً كاملاً للبيانات المنقولة.
                    </li>
                </ul>
            </section>

            <!-- Solution Section -->
            <section id="solution" class="section-card">
                <h2 class="text-2xl font-bold text-indigo-400 mb-4 border-b-2 border-gray-700 pb-2">6. الحل المقترح والتوصيات</h2>
                <p class="mb-4">
                    الحل المباشر هو إزالة الإعداد <code class="font-mono text-red-400">InsecureSkipVerify: true</code> لفرض التحقق الإلزامي من الشهادة.
                </p>
                <h3 class="text-lg font-semibold text-white mb-2 mt-6">التصحيح المقترح (Suggested Patch):</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Before -->
                    <div>
                        <h4 class="font-bold text-red-400 mb-2">قبل (Vulnerable):</h4>
                        <div class="code-block">
                            <button class="copy-btn" onclick="copyCode(this)">نسخ</button>
                            <pre><code class="language-diff">
- tlsConf = &tls.Config{
-     RootCAs:          certPool,
-     InsecureSkipVerify: true,
- }
                            </code></pre>
                        </div>
                    </div>
                    <!-- After -->
                    <div>
                        <h4 class="font-bold text-green-400 mb-2">بعد (Patched):</h4>
                        <div class="code-block">
                             <button class="copy-btn" onclick="copyCode(this)">نسخ</button>
                            <pre><code class="language-diff">
+ tlsConf = &tls.Config{
+     RootCAs:    certPool,
+     MinVersion: tls.VersionTLS12,
+     // Ensure hostname verification is performed
+     // ServerName should be set when dialing
+ }
                            </code></pre>
                        </div>
                    </div>
                </div>
                 <p class="mt-4 text-sm text-gray-400">
                    <strong class="text-green-400">تحسين إضافي:</strong> إضافة <code class="font-mono text-gray-300">MinVersion: tls.VersionTLS12</code> يضمن استخدام بروتوكولات TLS حديثة وآمنة، مما يعزز الموقف الأمني العام.
                </p>
            </section>
        </main>
    </div>

    <script>
        // Function to copy code to clipboard
        function copyCode(button) {
            const codeBlock = button.parentElement;
            const code = codeBlock.querySelector('code').innerText;
            const textArea = document.createElement('textarea');
            textArea.value = code;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                button.innerText = 'تم النسخ!';
            } catch (err) {
                console.error('Failed to copy text: ', err);
                button.innerText = 'فشل النسخ';
            }
            document.body.removeChild(textArea);
            setTimeout(() => {
                button.innerText = 'نسخ';
            }, 2000);
        }

        // Intersection Observer for scroll animations
        document.addEventListener("DOMContentLoaded", () => {
            const sections = document.querySelectorAll('.section-card');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('is-visible');
                        observer.unobserve(entry.target);
                    }
                });
            }, {
                threshold: 0.1
            });

            sections.forEach(section => {
                observer.observe(section);
            });
            
            // Animate header immediately
            const header = document.querySelector('header');
            if (header) {
                header.classList.add('is-visible');
            }
        });
    </script>
</body>
</html>

